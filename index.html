<html>

<head>
	<title>おさかな</title>
	<link rel="shortcut icon" href="umi_kani.ico" />

	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/css/theme.default.min.css">
	<link rel="stylesheet" href="style.css">
	<script type="text/javascript" src="weather.js"></script>
	<script type="text/javascript" src="osakana.js"></script>
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.min.js"></script>
	<!-- 追加機能(widgets)を使用する場合は次も追加する -->
	<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.widgets.min.js"></script>
	<script type="text/javascript">

		$(function () {
			/* お魚予測 (おさかな名　→ 時間Array) */
			var forecasts = {};
			/* (おさかな名 → おさかな行 */
			var details = {};

			for (var i = 0; i < osakanas.length; i++) {
				var osakana = osakanas[i];

				details[osakana.Fish] = osakana;

				var row = $('<tr>').attr('data-osakana', osakana.Fish);

				var caught = localStorage.getItem(osakana.Fish) == 'Yes';
				if (caught) {
					row.addClass('caught');
				}

				var checkbox = $('<input type="checkbox" class="caught">')
					.attr('value', osakana.Fish)
					.prop('checked', caught);
				row.append($('<td>').append(checkbox))
				

				var osakanaLink = $('<a></a>');
				if (osakana.Neko) {
					osakanaLink.attr('target', '_blank');
					osakanaLink.attr('href', 'https://ff14angler.com/fish/' + osakana.Neko);
				}
				osakanaLink.html(osakana.Fish)
				row.append($('<td>').append(osakanaLink))

				row.append($('<td>').append(osakana.Spot))
				row.append($('<td>').append(osakana.Zone))

				var time = "";
				if (osakana.From !== "") {
					time = ("0" + osakana.From).slice(-2) + ":00-" + ("0" + osakana.To).slice(-2) + ":00";
				}
				// console.log(osakana.Fish, osakana.From, osakana.To, time)

				var weather = "";
				if (osakana.Previous_Weather !== "" && osakana.Weather !== "") {
					/* 移ろいﾌｨｯｼｭ */
					weather = osakana.Previous_Weather + " → " + osakana.Weather;
				} else if (osakana.Weather !== "") {
					/* 移ろわないﾌｨｯｼｭ */
					weather = osakana.Weather;
				} else if (osakana.Previous_Weather !== "") {
					/* 移ろいじゃないけど前天候に依存するﾌｨｯｼｭ。ステタカントゥス、お前のことだ！ */
					weather = osakana.Previous_Weather + " → なんでも";
				}
				var wa = [];
				if (time.length) {
					wa.push(time);
				}
				if (weather.length) {
					wa.push(weather)
				}
				row.append($('<td>').html(wa.join('<br>')))


				var hints = $('<td class="hints">')
				function bakeIcon(className, text, unavailable) {
					var icon = $('<span></span>')
						.attr('class', 'fisher-icon ' + className)
						.attr('title', text)
					if (unavailable) {
						icon.addClass('unavailable')
					}
					return icon
				}

				hints.append(bakeIcon('bait', '餌: ' + osakana.Bait, osakana.Bait.length === 0))
				
				if (osakana.Mooch.length > 0) {
					hints.append(bakeIcon('mooch', '泳がせ: ' + osakana.Mooch))
				} else {
					hints.append(bakeIcon('mooch', '', true))
				}

				if (osakana.Hookset === 'プレシジョン') {
					hints.append(bakeIcon('precision-hookset', 'フックセット: プレシジョンフッキング'))
				} else if (osakana.Hookset === 'ストロング') {
					hints.append(bakeIcon('powerful-hookset', 'フックセット: ストロングフッキング'))
				} else {
					hints.append(bakeIcon('hook', '', true))
				}

				if (osakana.Fish_Eyes.length > 0) {
					hints.append(bakeIcon('fisheyes', 'フィッシュアイ: ' + osakana.Fish_Eyes))
				} else {
					hints.append(bakeIcon('fisheyes', '', true))
				}

				if (osakana.Intuition.length > 0) {
					hints.append(bakeIcon('intuition', '漁師の直感: ' + osakana.Intuition))
				} else {
					hints.append(bakeIcon('intuition', '', true))
				}
				row.append(hints)

				/* おさかなチャンス 2個 */
				var chances = getFishChance(2, osakana.Zone, osakana.Weather, osakana.Previous_Weather, osakana.From, osakana.To);
				forecasts[osakana.Fish] = chances;

				for (var x = 0; x < chances.length; x++) {
					var chance = chances[x];
					var start = getFormattedLocalTime(chance) + ' ' + getFormattedEorzeaTime(chance);
					var td = $('<td>');
					$('<span class="local-time">').append(getFormattedLocalTime(chance)).appendTo(td);
					$('<span class="eorzea-time">').append(getFormattedEorzeaTime(chance)).appendTo(td);
					td.appendTo(row);
				}
				$("#osakana_list tbody").append(row);
			}

			$("#osakana_list").tablesorter({
				widgets: ['saveSort'],
				widgetOptions: {
					saveSort: true
				},
				textExtraction: {
					".chance": function(node, table, cellIndex) {
						/* チャンスが月/日なので年を跨ぐとやばいので元の日付を使う */
						var osakana = $(node).parent('tr').attr('data-osakana');
						var chances = forecasts[osakana];
						/* cellIndex = 6 が #1 */
						var chance = chances[cellIndex - 6];
						return dateToYearMonthDayHoursMinutes(new Date(chance))
					}
				}
			});

			$(document).on("click", ".caught", function () {
				var checked = $(this).prop("checked");
				var fish = $(this).attr("value");
				var tr = $(this).parents('tr')
				if (checked) {
					tr.addClass('caught');
					if (shouldHideCaughtFish()) {
						tr.addClass('invisible');
					}
					localStorage.setItem(fish, 'Yes');
				} else {
					tr.removeClass('caught');
					tr.removeClass('invisible')
					localStorage.removeItem(fish);
				}
			})

			activateInvisibleFishFeature()
		})

		/* 釣ったおさかなさんを全部隠すor見せる機能 */
		function activateInvisibleFishFeature() {
			$('#hidingCaughtFish').on('change', function () {
				if ($(this).prop('checked')) {
					/* チェックが入ってたらlocalStorageにYes、半透明のおさかなさんたちをサヨナラ */
					localStorage.setItem('hidingCaughtFish', 'Yes');
					updateCaughtFishVisibility(false);
				} else {
					/* 逆 */
					localStorage.removeItem('hidingCaughtFish');
					updateCaughtFishVisibility(true);
				}
			})

			/* 初回はlocalStorageから */
			if (shouldHideCaughtFish()) {
				updateCaughtFishVisibility(false);
				$('#hidingCaughtFish').prop('checked', true)
			}
		}

		/* 隠したり見せたり */
		function updateCaughtFishVisibility(visible) {
			var tr = $('tr.caught');
			if (visible) {
				tr.removeClass('invisible')
			} else {
				tr.addClass('invisible')
			}
		}

		/* 釣ったおさかなさんは隠すべき？ */
		function shouldHideCaughtFish() {
			return localStorage.getItem('hidingCaughtFish') === 'Yes'
		}
	</script>
</head>

<body>
	<div class="bg"></div>
	<div class="kani"></div>
	<div class="same"></div>
	<div class="sun"></div>
	<div class="frame"></div>

	<div class="header">
		<div class="sun"></div>
		<input type="checkbox" id="hidingCaughtFish">
		<label for="hidingCaughtFish">釣れた魚に用はない</label>
	</div>
	<div class="footer"></div>

	<div class="content">
		<table id="osakana_list">
			<thead>
				<tr>
					<th class="sorter-false"></th>
					<th>おさかな</th>
					<th>スポット</th>
					<th>エリア</th>
					<th>条件</th>
					<th>釣り方</th>
					<th class="chance" data-chance-index="0">#1</th>
					<th class="chance" data-chance-index="1">#2</th>
				</tr>
			</thead>
			<tbody>
				<!-- ここにお魚さん -->
			</tbody>
		</table>
	</div>

	<body>

</html>