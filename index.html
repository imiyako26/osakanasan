<html>

<head>
	<title>おさかな</title>
	<link rel="shortcut icon" href="umi_kani.ico">
	<link rel="preload" href="fonts/azuki.woff" as="font" type="font/woff" crossorigin>
	<link rel="preload" href="images/fish_mola2.png" as="image" type="image/png">
	<link rel="stylesheet" href="style.css">
	<script type="text/javascript" src="weather.js"></script>
	<script type="text/javascript" src="osakana.js"></script>
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<!--
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<link rel="stylesheet" href="tablesorter.default.css">
	<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.min.js"></script>
	 追加機能(widgets)を使用する場合は次も追加する 
	<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.widgets.min.js"></script>-->
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

	<script type="text/javascript">
		/* お魚予測 (おさかな名　→ 時間Array) */
		var forecasts = {};
		/* おさかな名 → おさかな行 */
		var details = {};

		function formatTime(date) {
			return ("0" + date.getHours()).slice(-2) + ":" + ("0" + date.getMinutes()).slice(-2);
		}

		function formatTimeSpan(from, to) {
			if (from !== "") {
				return ("0" + from).slice(-2) + ":00-" + ("0" + to).slice(-2) + ":00";
			}
			return '';
		}

		function formatWeatherTransition(previousWeather, weather) {
			if (previousWeather !== "" && weather !== "") {
				/* 移ろいﾌｨｯｼｭ */
				return previousWeather + " → " + weather;
			} else if (weather !== "") {
				/* 移ろわないﾌｨｯｼｭ */
				return weather;
			} else if (previousWeather !== "") {
				/* 移ろいじゃないけど前天候に依存するﾌｨｯｼｭ。ステタカントゥス、お前のことだ！ */
				return previousWeather + " → なんでも";
			} else {
				return '';
			}
		}

		function formatHookset(value) {
			if (value === 'プレシジョン') {
				return 'プレシジョンフッキング';
			} else if (value === 'ストロング') {
				return 'ストロングフッキング';
			} else {
				return '';
			}
		}

		$(function () {
			for (var i = 0; i < osakanas.length; i++) {
				var osakana = osakanas[i];
				/* 釣れたかどうかのデータを追加 */
				osakana['Caught'] = localStorage.getItem(osakana.Fish) === 'Yes';
				details[osakana.Fish] = osakana;
			}

			/* 設定マンボウ */
			var molaVM = new Vue({
				el: '#mola',
				data: {
					open: false,
					/* 規定値はYes */
					realmreborn: localStorage.getItem('realmreborn') === null || localStorage.getItem('realmreborn') === 'Yes',
					heavensward: localStorage.getItem('heavensward') === null || localStorage.getItem('heavensward') === 'Yes',
					stormblood: localStorage.getItem('stormblood') === null || localStorage.getItem('stormblood') === 'Yes',
					shadowbringers: localStorage.getItem('shadowbringers') === null || localStorage.getItem('shadowbringers') === 'Yes',
					/* ヌシ */
					lord: localStorage.getItem('lord') === null || localStorage.getItem('lord') === 'Yes',
					/* 雑魚 規定値はNo */
					zako: localStorage.getItem('zako') === 'Yes'
				},
				watch: {
					realmreborn: function (newYesNo) {
						localStorage.setItem('realmreborn', newYesNo ? 'Yes' : 'No');
					},
					heavensward: function (newYesNo) {
						localStorage.setItem('heavensward', newYesNo ? 'Yes' : 'No');
					},
					stormblood: function (newYesNo) {
						localStorage.setItem('stormblood', newYesNo ? 'Yes' : 'No');
					},
					shadowbringers: function (newYesNo) {
						localStorage.setItem('shadowbringers', newYesNo ? 'Yes' : 'No');
					},
					lord: function (newYesNo) {
						localStorage.setItem('lord', newYesNo ? 'Yes' : 'No');
					},
					zako: function (newYesNo) {
						localStorage.setItem('zako', newYesNo ? 'Yes' : 'No');
					}
				}
			})

			/* 太陽奴 */
			var sunVM = new Vue({
				el: '#header',
				data: {
					current: new Date(),
					where: localStorage.getItem('where'),
					caughtFishHidden: localStorage.getItem('caughtFishHidden') === 'Yes'
				},
				watch: {
					/* 洋ナシスイッチON/OFFをlocalStorageに保存 */
					caughtFishHidden: function (newYesNo, oldYesNo) {
						if (newYesNo) {
							localStorage.setItem('caughtFishHidden', 'Yes');
						} else {
							localStorage.removeItem('caughtFishHidden');
						}
					},
					where: function (newWhere) {
						localStorage.setItem('where', newWhere);
					}
				},
				computed: {
					/* 過去2個、現在、未来2個の天気 */
					weathers: function() {
						/* 場所が設定されていないときはなし */
						if (!this.where) {
							return [];
						}

						var where = this.where;
						var zone = WeatherFinder.zoneJp[where];

						function calculateWindowWheather(millis) {
							var date = new Date(millis);
							var weather = WeatherFinder.getWeather(millis, zone);
							var eorzeaTime = WeatherFinder.getEorzeaTime(millis);
							eorzeaTime.setMinutes(0);
							/* 空白入りはclassに使えないよ */
							var weatherClassName = weather.replace(' ', '_')

							return {
								weather: weather,
								weatherJp: weatherEnToJp[weather],
								weatherClassName: weatherClassName,
								eorzeaTime: formatTime(eorzeaTime),
								localTime: formatTime(date)
							};
						}

						/* 8合わせ */
						var millis = WeatherFinder.getWeatherTimeFloor(this.current).getTime()
						return [
							calculateWindowWheather(millis - (175 * 16 * 1000)),
							calculateWindowWheather(millis - (175 * 8 * 1000)),
							calculateWindowWheather(millis),
							calculateWindowWheather(millis + (175 * 8 * 1000)),
							calculateWindowWheather(millis + (175 * 16 * 1000))
						];
					},
					eorzeaTime: function() {
						var time = WeatherFinder.getEorzeaTime(this.current.getTime());
						return formatTime(time);
					},
					zones: function() {
						return Object.keys(WeatherFinder.zoneJp);
					}
				}
			});

			/* 3秒毎に更新だよ */
			setInterval(function() {
				sunVM.current = new Date();
			}, 3000)

			/* 教えて！カニさん */
			var kaniVM = new Vue({
				el: '.senpai',
				data: {
					targetHowTo: localStorage.getItem('kani')
				},
				created: function () {
					this.informBody();
				},
				watch: {
					targetHowTo: function (newTarget, oldTarget) {
						if (newTarget) {
							localStorage.setItem('kani', newTarget);
						} else {
							localStorage.removeItem('kani');
						}
						this.informBody();
					}
				},
				computed: {
					osakana: function () {
						if (!this.targetHowTo) {
							return null;
						}
						return details[this.targetHowTo];
					}
				},
				methods: {
					formatTimeSpan: formatTimeSpan,
					formatWeatherTransition: formatWeatherTransition,
					formatHookset: formatHookset,
					informBody: function () {
						if (this.targetHowTo) {
							$(document.body).addClass('senpai-visible');
						} else {
							$(document.body).removeClass('senpai-visible');
						}
					}
				}
			})

			/* おさかなさんリスト */
			var listVM = new Vue({
				el: '.content',
				data: {
					kaniVM: kaniVM,
					osakanas: osakanas,
					sortBy: localStorage.getItem('sortBy'),
					reversed: localStorage.getItem('sortByReversed') === 'Yes'
				},
				watch: {
					sortBy: function (newSortBy) {
						localStorage.setItem('sortBy', newSortBy)
					},
					reversed: function (newReversed) {
						localStorage.setItem('sortByReversed', newReversed ? 'Yes' : 'No')
					}
				},
				computed: {
					/* リストはソートされてるお魚さんを表示 */
					sortedOsakanas: function () {
						var copy = [];
						for (var i = 0; i < this.osakanas.length; i++) {
							if (this.shouldList(this.osakanas[i])) {
								copy.push(this.osakanas[i]);
							}
						}

						var self = this;
						var factor = this.sortBy;
						copy.sort(function (a, b) {
							var comparison;
							switch (factor) {
								case 'chance1': {
									/* chanceは日付の数値 */
									var chanceA = self.getChance(a, 0);
									var chanceB = self.getChance(b, 0);
									comparison = chanceA - chanceB;
									break;
								}
								case 'chance2': {
									var chanceA = self.getChance(a, 1);
									var chanceB = self.getChance(b, 1);
									comparison = chanceA - chanceB;
									break;
								}
								case 'spot': {
									comparison = a.Spot.localeCompare(b.Spot);
									break;
								}
								case 'zone': {
									comparison = a.Zone.localeCompare(b.Zone);
									break;
								}
								case 'name':
								default:
									comparison = a.Fish.localeCompare(b.Fish)
									break;
							}

							if (self.reversed) {
								comparison = -comparison;
							}
							return comparison;
						});
						return copy;
					},
				},
				methods: {
					formatTimeSpan: formatTimeSpan,
					formatWeatherTransition: formatWeatherTransition,
					formatHookset: formatHookset,
					getOsakanaLink: function (osakana) {
						return 'https://ff14angler.com/fish/' + osakana.Neko;
					},
					checkVersion: function (osakana) {
						if (!osakana.Since)
							return true;
						if (osakana.Since < 3) {
							return molaVM.realmreborn;
						} else if (osakana.Since < 4) {
							return molaVM.heavensward;
						} else if (osakana.Since < 5) {
							return molaVM.stormblood;
						} else if (osakana.Since < 6) {
							return molaVM.shadowbringers;
						} else {
							return true;
						}
					},
					checkKind: function (osakana) {
						if (osakana.Lord === 'Yes') {
							return molaVM.lord;
						} else {
							return molaVM.zako;
						}
					},
					shouldList: function (osakana) {
						return (!osakana.Caught || !sunVM.caughtFishHidden) && this.checkVersion(osakana) && this.checkKind(osakana);
					},
					getChances: function (osakana) {
						/* チャンス計算は一回だけ */
						var chances = forecasts[osakana.Fish];
						if (!chances) {
							chances = getFishChance(2, osakana.Zone, osakana.Weather, osakana.Previous_Weather, osakana.From, osakana.To);
							forecasts[osakana.Fish] = chances;
						}
						return chances;
					},
					getChance: function (osakana, nth) {
						return this.getChances(osakana)[nth];
					},
					getChanceLT: function (osakana, nth) {
						return getFormattedLocalTime(this.getChance(osakana, nth));
					},
					getChanceET: function (osakana, nth) {
						return getFormattedEorzeaTime(this.getChance(osakana, nth));
					},
					getHooksetClass: function (osakana) {
						if (osakana.Hookset === 'プレシジョン') {
							return 'precision-hookset';
						} else if (osakana.Hookset === 'ストロング') {
							return 'powerful-hookset';
						} else {
							return 'hook';
						}
					},
					/* カニさんに教えを乞う */
					teachMe: function (osakana) {
						kaniVM.targetHowTo = osakana.Fish;
					},
					catchFish: function (osakana) {
						osakana.Caught = !osakana.Caught;
						if (osakana.Caught) {
							localStorage.setItem(osakana.Fish, 'Yes');
						} else {
							localStorage.removeItem(osakana.Fish);
						}
					},

					changeSortBy: function (sortBy) {
						if (this.sortBy === sortBy) {
							/* 現在の並び替えファクタをクリックしたら順を逆に */
							this.sortBy = sortBy;
							this.reversed = !this.reversed;
						} else {
							/* 別のソート対象だったら昇順 */
							this.sortBy = sortBy;
							this.reversed = false;
						}
					},
					sortColumnClass: function (sortBy) {
						if (this.sortBy === sortBy) {
							if (this.reversed) {
								return 'sort-column-descending';
							} else {
								return 'sort-column-ascending';
							}
						} else {
							return 'sort-column';
						}
					}
				}
			});

			var last_known_scroll_position = 0;
			var ticking = false;

			function doSomething(scroll_pos) {
				// console.log(scroll_pos)
				if (scroll_pos > 10) {
					$(document.body).addClass('scrolled')
				} else {
					$(document.body).removeClass('scrolled')
				}
			}

			window.addEventListener('scroll', function (e) {
				last_known_scroll_position = window.scrollY;

				if (!ticking) {
					window.requestAnimationFrame(function () {
						doSomething(last_known_scroll_position);
						ticking = false;
					});

					ticking = true;
				}
			});
		})
	</script>
</head>

<body>
	<div class="bg"></div>

	<div class="senpai">
		<div class="kani"></div>
		<div class="same"></div>
		<div class="kanban">
			<div class="kanban-close" @click="targetHowTo = null"></div>
			<div class="kanban-content" v-if="osakana">
				<h1>{{ osakana.Fish }}</h1>
				<div>{{ osakana.Spot }} {{ osakana.Zone }}</div>
				<table>
					<tr v-if="osakana.To">
						<th>時間</th>
						<td>{{ formatTimeSpan(osakana.From, osakana.To) }}</td>
					</tr>
					<tr v-if="osakana.Weather || osakana.Previous_Weather">
						<th>天候</th>
						<td>{{ formatWeatherTransition(osakana.Previous_Weather, osakana.Weather) }}</td>
					</tr>
					<tr v-if="osakana.Bait">
						<th>エサ</th>
						<td>{{ osakana.Bait }}</td>
					</tr>
					<tr v-if="osakana.Mooch">
						<th>泳がせ</th>
						<td>{{ osakana.Mooch }}</td>
					</tr>
					<tr v-if="formatHookset(osakana.Hookset)">
						<th>フッキング</th>
						<td>{{ formatHookset(osakana.Hookset) }}</td>
					</tr>
					<tr v-if="osakana.Fish_Eyes">
						<th>フィッシュアイ</th>
						<td>{{ osakana.Fish_Eyes }}</td>
					</tr>
					<tr v-if="osakana.Intuition">
						<th>漁師の直観</th>
						<td>{{ osakana.Intuition }}</td>
					</tr>
					<tr v-if="osakana.Remark">
						<td colspan="2">{{ osakana.Remark }}</td>
					</tr>
				</table>
			</div>
		</div>
	</div>

	<div class="footer"></div>

	<div class="sun"></div>
	<div class="frame"></div>

	<div id="header">
		<div class="sun"></div>
		<div class="header-content">
			<div class="where">
				<select v-model="where">
					<option :value="null">どこにいる？</option>
					<option v-for="zone in zones" :key="zone" :value="zone">{{ zone }}</option>
				</select>
			</div>
			<div class="forecasts">
				<!-- v-for → v-ifの順らしい -->
				<template v-if="where">
					<span v-for="(weatherWindow, nth) in weathers"
						:class="['weather', weatherWindow.weatherClassName, nth === 2 ? 'present' : null, nth < 2 ? 'backcast' : null]"
						:title="weatherWindow.weatherJp + ' ET' + weatherWindow.eorzeaTime"
						:key="nth"></span>
				</template>
			</div>
			<div class="current-time">
				ET{{ eorzeaTime }}
			</div>
			<div class="nashi">
				<input type="checkbox" id="caughtFishHidden" v-model="caughtFishHidden">
				<label for="caughtFishHidden">釣れた魚に用はない</label>
			</div>
		</div>
	</div>

	<div id="mola" :class="[open ? 'open' : null]">
		<div class="appearance-hook" @click="open = !open" :title="open ? 'リリース！' : 'ストロングフッキング！'"></div>
		<div class="filters">
			<div class="kind">
				<h1>種類</h1>
				<ul>
					<li>
						<input type="checkbox" v-model="lord" id="lord" />
						<label for="lord">ヌシ</label>
					</li>
					<li>
						<input type="checkbox" v-model="zako" id="zako" />
						<label for="zako">雑魚</label>
					</li>
				</ul>
			</div>
			<div class="since">
				<h1>いつ？</h1>
				<ul>
					<li>
						<input type="checkbox" v-model="realmreborn" id="realmreborn" />
						<label for="realmreborn">新生</label>
					</li>
					<li>
						<input type="checkbox" v-model="heavensward" id="heavensward" />
						<label for="heavensward">蒼天</label>
					</li>
					<li>
						<input type="checkbox" v-model="stormblood" id="stormblood" />
						<label for="stormblood">紅蓮</label>
					</li>
					<li>
						<input type="checkbox" v-model="shadowbringers" id="shadowbringers" />
						<label for="shadowbringers">漆黒</label>
					</li>
				</ul>
			</div>
		</div>
	</div>

	<div class="copyright">
		Copyright (C) 2010 - 2020 SQUARE ENIX CO., LTD. All Rights Reserved.
	</div>

	<div class="content">
		<table id="osakana_list">
			<thead>
				<tr>
					<th class="checkbox-cell"></th>
					<th @click="changeSortBy('name')" :class="sortColumnClass('name')">おさかな</th>
					<th @click="changeSortBy('spot')" :class="sortColumnClass('spot')">スポット</th>
					<th @click="changeSortBy('zone')" :class="sortColumnClass('zone')">エリア</th>
					<th>条件</th>
					<th>釣り方</th>
					<th @click="changeSortBy('chance1')" :class="sortColumnClass('chance1')">#1</th>
					<th @click="changeSortBy('chance2')" :class="sortColumnClass('chance2')">#2</th>
				</tr>
			</thead>
			<tbody>
				<!-- ここにお魚さん -->
				<!-- <a>や<input>にはv-on:click.stopが必須。ないとクリックしたときにカニさんがお節介を焼いてしまう -->
				<tr v-for="osakana in sortedOsakanas" 
						v-on:click="teachMe(osakana)"
						:key="osakana.Neko"
						:class="[osakana.Fish === kaniVM.targetHowTo ? 'highlight' : null]">
					<td class="checkbox-cell">
						<!-- v-model使うとwatchの仕方が分からない -->
						<input type="checkbox" 
							:id="'caught-' + osakana.Neko"
							:checked="osakana.Caught" 
							v-on:change="catchFish(osakana)"
							v-on:click.stop
							class="large-checkbox">
						<label 
							class="large-checkbox-deco" 
							:for="'caught-' + osakana.Neko"
							v-on:click.stop></label>
					</td>
					<td><a target="_blank" :href="getOsakanaLink(osakana)" v-on:click.stop>{{ osakana.Fish }}</a></td>
					<td>{{ osakana.Spot }}</td>
					<td>{{ osakana.Zone }}</td>
					<td>
						<span class="time" v-if="osakana.To !== ''">
							{{ formatTimeSpan(osakana.From, osakana.To) }}
						</span>
						<span class="weather" v-if="osakana.Weather !== '' || osakana.Previous_Weather !== ''">
							{{ formatWeatherTransition(osakana.Previous_Weather, osakana.Weather) }}
						</span>
					</td>
					<td class="hints">
						<span class="fisher-icon bait" :title="osakana.Bait"></span>
						<span :class="['fisher-icon', 'mooch', osakana.Mooch.length === 0 ? 'unavailable' : '']"
							:title="osakana.Mooch"></span>
						<span
							:class="['fisher-icon',	getHooksetClass(osakana), getHooksetClass(osakana) === 'hook' ? 'unavailable' : '']"
							:title="formatHookset(osakana.Hookset)"></span>
						<span :class="['fisher-icon', 'fisheyes', osakana.Fish_Eyes.length === 0 ? 'unavailable' : '']"
							:title="osakana.Fish_Eyes"></span>
						<span :class="['fisher-icon', 'intuition', osakana.Intuition.length === 0 ? 'unavailable' : '']"
							:title="osakana.Intuition"></span>
					</td>
					<td class="chance">
						<span class="local-time">{{ getChanceLT(osakana, 0) }}</span>
						<span class="eorzea-time">{{ getChanceET(osakana, 0) }}</span>
					</td>
					<td class="chance">
						<span class="local-time">{{ getChanceLT(osakana, 1) }}</span>
						<span class="eorzea-time">{{ getChanceET(osakana, 1) }}</span>
					</td>
				</tr>
			</tbody>
		</table>
	</div>

	<div class="kani-space"></div>
</body>

</html>