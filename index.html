<html>

<head>
	<title>おさかな</title>
	<link rel="shortcut icon" href="umi_kani.ico">
	<link rel="preload" href="fonts/azuki.woff" as="font" type="font/woff" crossorigin>
	<link rel="stylesheet" href="tablesorter.default.css">
	<link rel="stylesheet" href="style.css">
	<script type="text/javascript" src="weather.js"></script>
	<script type="text/javascript" src="osakana.js"></script>
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.min.js"></script>
	<!-- 追加機能(widgets)を使用する場合は次も追加する -->
	<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.widgets.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	
	<script type="text/javascript">
		/* お魚予測 (おさかな名　→ 時間Array) */
		var forecasts = {};
		/* おさかな名 → おさかな行 */
		var details = {};

		function initializeOsakanaList() {
			/* 先にtablesorterを作成 */
			$("#osakana_list").tablesorter({
				widgets: ['saveSort'],
				widgetOptions: {
					saveSort: true
				},
				textExtraction: {
					".chance": function (node, table, cellIndex) {
						/* チャンスが月/日なので年を跨ぐとやばいので元の日付を使う */
						var osakana = $(node).parent('tr').attr('data-osakana');
						var chances = forecasts[osakana];
						/* cellIndex = 6 が #1 */
						var chance = chances[cellIndex - 6];
						return dateToYearMonthDayHoursMinutes(new Date(chance))
					}
				}
			});

			updateOsakanaRows();
		}

		function updateOsakanaRows() {
			for (var i = 0; i < osakanas.length; i++) {
				var osakana = osakanas[i];
				var present = isOsakanaRowPresent(osakana);
				var toShow = shouldShowOsakana(osakana);
				// console.log(osakana.Fish, present, toShow)
				if (present) {
					if (!toShow) {
						removeOsakanaRow(osakana)
					}
				} else {
					if (toShow) {
						addOsakanaRow(osakana)
					}
				}
			}
			
			$('#osakana_list').trigger('update', [ true, function() { 
			}])
		}

		/* 釣られたおさかなか？ */
		function wasCaughtOsakana(osakana) {
			return localStorage.getItem(osakana.Fish) == 'Yes';
		}

		/* おさかなは表示すべき？ */
		function shouldShowOsakana(osakana) {
			var caught = wasCaughtOsakana(osakana);
			return !caught || !shouldHideCaughtFish();
		}

		function isOsakanaRowPresent(osakana) {
			return $('tr[data-osakana="' + osakana.Fish + '"]').length >= 1;
		}

		function removeOsakanaRow(osakana) {
			var tr = $('tr[data-osakana="' + osakana.Fish + '"]');
			tr.remove();
		}

		function addOsakanaRow(osakana) {
			var row = $('<tr>').attr('data-osakana', osakana.Fish);

			/* 既に釣れてるおさかなマーク */
			var caught = localStorage.getItem(osakana.Fish) == 'Yes';
			if (wasCaughtOsakana(osakana)) {
				row.addClass('caught');
			}

			var checkbox = $('<input type="checkbox" class="caught">')
				.prop('checked', caught);
			row.append($('<td>').append(checkbox))

			var osakanaLink = bakeOsakanaLink(osakana)
			row.append($('<td>').append(osakanaLink))
			row.append($('<td>').append(osakana.Spot))
			row.append($('<td>').append(osakana.Zone))

			var time = formatTimeSpan(osakana.From, osakana.To);
			var weather = formatWeatherTransition(osakana.Previous_Weather, osakana.Weather);
			var wa = [];
			if (time.length) {
				wa.push(time);
			}
			if (weather.length) {
				wa.push(weather);
			}
			row.append($('<td>').html(wa.join('<br>')));


			var hints = document.createElement('td');
			hints.appendChild(bakeIcon('bait', '餌: ' + osakana.Bait, osakana.Bait.length === 0))

			if (osakana.Mooch.length > 0) {
				hints.appendChild(bakeIcon('mooch', '泳がせ: ' + osakana.Mooch))
			} else {
				hints.appendChild(bakeIcon('mooch', '', true))
			}

			if (osakana.Hookset === 'プレシジョン') {
				hints.appendChild(bakeIcon('precision-hookset', 'フッキング: プレシジョンフッキング'))
			} else if (osakana.Hookset === 'ストロング') {
				hints.appendChild(bakeIcon('powerful-hookset', 'フッキング: ストロングフッキング'))
			} else {
				hints.appendChild(bakeIcon('hook', '', true))
			}

			if (osakana.Fish_Eyes.length > 0) {
				hints.appendChild(bakeIcon('fisheyes', 'フィッシュアイ: ' + osakana.Fish_Eyes))
			} else {
				hints.appendChild(bakeIcon('fisheyes', '', true))
			}

			if (osakana.Intuition.length > 0) {
				hints.appendChild(bakeIcon('intuition', '漁師の直感: ' + osakana.Intuition))
			} else {
				hints.appendChild(bakeIcon('intuition', '', true))
			}
			row.append(hints)

			/* おさかなチャンス 2個 */
			var chances = forecasts[osakana.Fish];
			if (!chances) {
				chances = getFishChance(2, osakana.Zone, osakana.Weather, osakana.Previous_Weather, osakana.From, osakana.To);
				forecasts[osakana.Fish] = chances;
			}

			for (var x = 0; x < chances.length; x++) {
				var chance = chances[x];
				var start = getFormattedLocalTime(chance) + ' ' + getFormattedEorzeaTime(chance);
				var td = $('<td>');
				$('<span class="local-time">').append(getFormattedLocalTime(chance)).appendTo(td);
				$('<span class="eorzea-time">').append(getFormattedEorzeaTime(chance)).appendTo(td);
				td.appendTo(row);
			}
			$("#osakana_list tbody").append(row);
		}

		
		function formatTimeSpan(from, to) {
			if (from !== "") {
				return ("0" + from).slice(-2) + ":00-" + ("0" + to).slice(-2) + ":00";
			}
			return '';
		}
		
		function formatWeatherTransition(previousWeather, weather) {			
			if (previousWeather !== "" && weather !== "") {
				/* 移ろいﾌｨｯｼｭ */
				return previousWeather + " → " + weather;
			} else if (weather !== "") {
				/* 移ろわないﾌｨｯｼｭ */
				return weather;
			} else if (previousWeather !== "") {
				/* 移ろいじゃないけど前天候に依存するﾌｨｯｼｭ。ステタカントゥス、お前のことだ！ */
				return previousWeather + " → なんでも";
			} else {
				return '';
			}
		}

		function bakeIcon(className, text, unavailable) {
			var classes = ['fisher-icon', className];
			if (unavailable) 
				classes.push('unavailable');

			var icon = document.createElement('span');
			icon.setAttribute('class', classes.join(' '));
			icon.setAttribute('title', text)
			return icon
		}

		function bakeOsakanaLink(osakana) {
			var a = document.createElement('a')
			if (osakana.Neko) {
				a.setAttribute('target', '_blank');
				a.setAttribute('href', 'https://ff14angler.com/fish/' + osakana.Neko);
			}
			a.innerHTML = osakana.Fish;
			return a;
		}

		/* 釣ったおさかなさんは隠すべき？ */
		function shouldHideCaughtFish() {
			return headerVM.caughtFishHidden;
		}
			
		function formatHookset(value) {
			if (value === 'プレシジョン') {
				return 'プレシジョンフッキング';
			} else if (value === 'ストロング') {
				return 'ストロングフッキング';
			} else {
				return '';
			}
		}
		
		var headerVM, kaniVM;
		$(function () {			
			for (var i = 0; i < osakanas.length; i++) {
				var osakana = osakanas[i];
				details[osakana.Fish] = osakana;
			}

			/* 用はない！ */
			headerVM = new Vue({
				el: '.header',
				data: {
					caughtFishHidden: localStorage.getItem('hidingCaughtFish') === 'Yes',
				},
				watch: {
					/* 洋ナシスイッチON/OFFをlocalStorageに保存 */
					caughtFishHidden: function(newYesNo, oldYesNo) {
						if (newYesNo) {
							localStorage.setItem('hidingCaughtFish', 'Yes');
						} else {
							localStorage.removeItem('hidingCaughtFish');
						}
						updateOsakanaRows();
					}
				}
			});

			/* 教えて！カニさん */
			kaniVM = new Vue({
				el: '.senpai',
				data: {
					targetHowTo: localStorage.getItem('kani')
				},
				created: function() {
					this.informBody();
				},
				watch: {
					targetHowTo: function(newTarget, oldTarget) {						
						if (newTarget) {
							localStorage.setItem('kani', newTarget);
						} else {
							localStorage.removeItem('kani');
						}
						this.informBody();
					}
				},
				computed: {
					osakana: function() {
						if (!this.targetHowTo) {
							return null;
						}
						return details[this.targetHowTo];
					}
				},
				methods: {
					formatTimeSpan: formatTimeSpan,
					formatWeatherTransition: formatWeatherTransition,
					formatHookset: formatHookset,
					informBody: function() {
						if (this.targetHowTo) {
							$(document.body).addClass('senpai-visible');
						} else {
							$(document.body).removeClass('senpai-visible');
						}
					}
				}
			})
			
			$('#osakana_list').on('click', 'tbody tr', function() {
				var osakanaName = $(this).attr('data-osakana');
				kaniVM.targetHowTo = osakanaName;
			})
			
			initializeOsakanaList();

			$(document).on("click", ".caught", function () {
				var checked = $(this).prop("checked");
				var tr = $(this).parents('tr')
				var fish = tr.attr('data-osakana')
				if (checked) {
					tr.addClass('caught');
					localStorage.setItem(fish, 'Yes');
				} else {
					tr.removeClass('caught');
					localStorage.removeItem(fish);
				}

				updateOsakanaRows();
			})
		})
	</script>
</head>

<body>
	<div class="bg"></div>

	<div class="senpai">
		<div class="kanban">
			<div class="kanban-close" @click="targetHowTo = null"></div>
			<div class="kanban-content" v-if="osakana">
				<h1>{{ osakana.Fish }}</h1>
				<div>{{ osakana.Spot }} {{ osakana.Zone }}</div>
				<table>
					<tr v-if="osakana.To">
						<th>時間</th>
						<td>{{ formatTimeSpan(osakana.From, osakana.To) }}</td>
					</tr>
					<tr v-if="osakana.Weather || osakana.Previous_Weather">
						<th>天候</th>
						<td>{{ formatWeatherTransition(osakana.Previous_Weather, osakana.Weather) }}</td>
					</tr>
					<tr v-if="osakana.Bait">
						<th>エサ</th>
						<td>{{ osakana.Bait }}</td>
					</tr>
					<tr v-if="osakana.Mooch">
						<th>泳がせ</th>
						<td>{{ osakana.Mooch }}</td>
					</tr>
					<tr v-if="formatHookset(osakana.Hookset)">
						<th>フッキング</th>
						<td>{{ formatHookset(osakana.Hookset) }}</td>
					</tr>
					<tr v-if="osakana.Fish_Eyes">
						<th>フィッシュアイ</th>
						<td>{{ osakana.Fish_Eyes }}</td>
					</tr>
					<tr v-if="osakana.Intuition">
						<th>漁師の直観</th>
						<td>{{ osakana.Intuition }}</td>
					</tr>
					<tr v-if="osakana.Remark">
						<td colspan="2">{{ osakana.Remark }}</td>
					</tr>
				</table>
			</div>
		</div>
		<div class="kani"></div>
		<div class="same"></div>
	</div>
	<div class="footer"></div>

	<div class="sun"></div>
	<div class="frame"></div>

	<div class="header">
		<div class="sun"></div>
		<input type="checkbox" id="hidingCaughtFish" v-model="caughtFishHidden">
		<label for="hidingCaughtFish">釣れた魚に用はない</label>
	</div>

	<div class="copyright">		
		Copyright (C) 2010 - 2020 SQUARE ENIX CO., LTD. All Rights Reserved.
	</div>

	<div class="content">
		<table id="osakana_list">
			<thead>
				<tr>
					<th class="sorter-false"></th>
					<th>おさかな</th>
					<th>スポット</th>
					<th>エリア</th>
					<th>条件</th>
					<th>釣り方</th>
					<th class="chance" data-chance-index="0">#1</th>
					<th class="chance" data-chance-index="1">#2</th>
				</tr>
			</thead>
			<tbody>
				<!-- ここにお魚さん -->
			</tbody>
		</table>
	</div>

	<div class="kani-space"></div>
</body>
</html>